{"version":3,"sources":["../src/next-legacy.ts"],"sourcesContent":["// This node import should be fine since it's available in both node and edge runtimes\n// https://vercel.com/docs/functions/edge-functions/edge-runtime#compatible-node.js-modules\nimport { EventEmitter } from \"events\";\nimport type { NextApiRequest, NextApiResponse } from \"next\";\n\nimport { getStatusCodeFromError, UploadThingError } from \"@uploadthing/shared\";\nimport type { Json } from \"@uploadthing/shared\";\n\nimport { UPLOADTHING_VERSION } from \"./constants\";\nimport { formatError } from \"./internal/error-formatter\";\nimport {\n  buildPermissionsInfoHandler,\n  buildRequestHandler,\n} from \"./internal/handler\";\nimport type { RouterWithConfig } from \"./internal/handler\";\nimport { incompatibleNodeGuard } from \"./internal/incompat-node-guard\";\nimport type { FileRouter } from \"./internal/types\";\nimport type { CreateBuilderOptions } from \"./internal/upload-builder\";\nimport { createBuilder } from \"./internal/upload-builder\";\n\nexport type { FileRouter } from \"./internal/types\";\n\nexport const createUploadthing = <TErrorShape extends Json>(\n  opts?: CreateBuilderOptions<TErrorShape>,\n) =>\n  createBuilder<\n    { req: NextApiRequest; res: NextApiResponse; event: undefined },\n    TErrorShape\n  >(opts);\n\nexport const createNextPageApiHandler = <TRouter extends FileRouter>(\n  opts: RouterWithConfig<TRouter>,\n) => {\n  incompatibleNodeGuard();\n  const ee = new EventEmitter();\n  const requestHandler = buildRequestHandler<TRouter>(opts, ee);\n\n  const getBuildPerms = buildPermissionsInfoHandler<TRouter>(opts);\n\n  return async (req: NextApiRequest, res: NextApiResponse) => {\n    // Return valid endpoints\n    if (req.method === \"GET\") {\n      const clientPollingKey = req.headers[\"x-uploadthing-polling-key\"];\n      if (clientPollingKey) {\n        const eventData = await new Promise((resolve) => {\n          ee.addListener(\"callbackDone\", resolve);\n        });\n        ee.removeAllListeners(\"callbackDone\");\n\n        res.setHeader(\"x-uploadthing-version\", UPLOADTHING_VERSION);\n        res.status(200).json(eventData);\n        return;\n      }\n\n      const perms = getBuildPerms();\n      res.status(200).json(perms);\n      return;\n    }\n\n    const proto = (req.headers[\"x-forwarded-proto\"] as string) ?? \"http\";\n    const url = new URL(req.url ?? \"/\", `${proto}://${req.headers.host}`);\n\n    const response = await requestHandler({\n      req: Object.assign(req, {\n        json: () =>\n          Promise.resolve(\n            typeof req.body === \"string\" ? JSON.parse(req.body) : req.body,\n          ),\n      }),\n      url,\n      res,\n    });\n\n    res.setHeader(\"x-uploadthing-version\", UPLOADTHING_VERSION);\n\n    if (response instanceof UploadThingError) {\n      res.status(getStatusCodeFromError(response));\n      res.setHeader(\"x-uploadthing-version\", UPLOADTHING_VERSION);\n      return res.json(formatError(response, opts.router));\n    }\n\n    if (response.status !== 200) {\n      // We messed up - this should never happen\n      res.status(500);\n      return res.send(\"An unknown error occured\");\n    }\n\n    res.status(response.status);\n    return res.json(response.body);\n  };\n};\n"],"mappings":";;;;;;;;;;;;;AAEA,SAAS,oBAAoB;AAG7B,SAAS,wBAAwB,wBAAwB;AAiBlD,IAAM,oBAAoB,CAC/B,SAEA,cAGE,IAAI;AAED,IAAM,2BAA2B,CACtC,SACG;AACH,wBAAsB;AACtB,QAAM,KAAK,IAAI,aAAa;AAC5B,QAAM,iBAAiB,oBAA6B,MAAM,EAAE;AAE5D,QAAM,gBAAgB,4BAAqC,IAAI;AAE/D,SAAO,OAAO,KAAqB,QAAyB;AAE1D,QAAI,IAAI,WAAW,OAAO;AACxB,YAAM,mBAAmB,IAAI,QAAQ,2BAA2B;AAChE,UAAI,kBAAkB;AACpB,cAAM,YAAY,MAAM,IAAI,QAAQ,CAAC,YAAY;AAC/C,aAAG,YAAY,gBAAgB,OAAO;AAAA,QACxC,CAAC;AACD,WAAG,mBAAmB,cAAc;AAEpC,YAAI,UAAU,yBAAyB,mBAAmB;AAC1D,YAAI,OAAO,GAAG,EAAE,KAAK,SAAS;AAC9B;AAAA,MACF;AAEA,YAAM,QAAQ,cAAc;AAC5B,UAAI,OAAO,GAAG,EAAE,KAAK,KAAK;AAC1B;AAAA,IACF;AAEA,UAAM,QAAS,IAAI,QAAQ,mBAAmB,KAAgB;AAC9D,UAAM,MAAM,IAAI,IAAI,IAAI,OAAO,KAAK,GAAG,WAAW,IAAI,QAAQ,MAAM;AAEpE,UAAM,WAAW,MAAM,eAAe;AAAA,MACpC,KAAK,OAAO,OAAO,KAAK;AAAA,QACtB,MAAM,MACJ,QAAQ;AAAA,UACN,OAAO,IAAI,SAAS,WAAW,KAAK,MAAM,IAAI,IAAI,IAAI,IAAI;AAAA,QAC5D;AAAA,MACJ,CAAC;AAAA,MACD;AAAA,MACA;AAAA,IACF,CAAC;AAED,QAAI,UAAU,yBAAyB,mBAAmB;AAE1D,QAAI,oBAAoB,kBAAkB;AACxC,UAAI,OAAO,uBAAuB,QAAQ,CAAC;AAC3C,UAAI,UAAU,yBAAyB,mBAAmB;AAC1D,aAAO,IAAI,KAAK,YAAY,UAAU,KAAK,MAAM,CAAC;AAAA,IACpD;AAEA,QAAI,SAAS,WAAW,KAAK;AAE3B,UAAI,OAAO,GAAG;AACd,aAAO,IAAI,KAAK,0BAA0B;AAAA,IAC5C;AAEA,QAAI,OAAO,SAAS,MAAM;AAC1B,WAAO,IAAI,KAAK,SAAS,IAAI;AAAA,EAC/B;AACF;","names":[]}