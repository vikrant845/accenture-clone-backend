import {
  incompatibleNodeGuard
} from "./chunk-WPSY3MFJ.mjs";
import {
  UPLOADTHING_VERSION,
  buildPermissionsInfoHandler,
  buildRequestHandler,
  createBuilder,
  formatError
} from "./chunk-TYV4HEV2.mjs";
import "./chunk-T2XS27LC.mjs";

// src/next-legacy.ts
import { EventEmitter } from "events";
import { getStatusCodeFromError, UploadThingError } from "@uploadthing/shared";
var createUploadthing = (opts) => createBuilder(opts);
var createNextPageApiHandler = (opts) => {
  incompatibleNodeGuard();
  const ee = new EventEmitter();
  const requestHandler = buildRequestHandler(opts, ee);
  const getBuildPerms = buildPermissionsInfoHandler(opts);
  return async (req, res) => {
    if (req.method === "GET") {
      const clientPollingKey = req.headers["x-uploadthing-polling-key"];
      if (clientPollingKey) {
        const eventData = await new Promise((resolve) => {
          ee.addListener("callbackDone", resolve);
        });
        ee.removeAllListeners("callbackDone");
        res.setHeader("x-uploadthing-version", UPLOADTHING_VERSION);
        res.status(200).json(eventData);
        return;
      }
      const perms = getBuildPerms();
      res.status(200).json(perms);
      return;
    }
    const proto = req.headers["x-forwarded-proto"] ?? "http";
    const url = new URL(req.url ?? "/", `${proto}://${req.headers.host}`);
    const response = await requestHandler({
      req: Object.assign(req, {
        json: () => Promise.resolve(
          typeof req.body === "string" ? JSON.parse(req.body) : req.body
        )
      }),
      url,
      res
    });
    res.setHeader("x-uploadthing-version", UPLOADTHING_VERSION);
    if (response instanceof UploadThingError) {
      res.status(getStatusCodeFromError(response));
      res.setHeader("x-uploadthing-version", UPLOADTHING_VERSION);
      return res.json(formatError(response, opts.router));
    }
    if (response.status !== 200) {
      res.status(500);
      return res.send("An unknown error occured");
    }
    res.status(response.status);
    return res.json(response.body);
  };
};
export {
  createNextPageApiHandler,
  createUploadthing
};
//# sourceMappingURL=next-legacy.mjs.map